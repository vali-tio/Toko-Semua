<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Admin Toko - Final (All-in-One)</title>
   <link rel="manifest" href="manifest.webmanifest">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Tema pastel lembut */
    .theme-blue  { --main: #93c5fd; --main-600:#2563eb; }
    .theme-green { --main: #a7f3d0; --main-600:#059669; }
    .theme-purple{ --main: #e9d5ff; --main-600:#7c3aed; }
    .theme-cream { --main: #fde68a; --main-600:#d97706; }
    .btn-main { background-color: var(--main); }
    .btn-main:hover { filter: brightness(0.95); }
    .ring-main:focus { outline: none; box-shadow: 0 0 0 4px rgba(0,0,0,0.05), 0 0 0 4px var(--main); }
    .backdrop { background: rgba(0,0,0,0.45); }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 theme-blue">

<!-- GEAR ICON / ADMIN TOGGLE -->
<button id="gearBtn" class="fixed top-4 right-4 bg-white p-3 rounded-full shadow-md">‚öôÔ∏è</button>

<!-- Header (public) -->
<header class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-4 mb-4 flex items-center justify-between">
  <div>
    <h1 id="siteTitle" class="text-xl font-bold text-gray-800">Nama Toko</h1>
    <p id="siteSubtitle" class="text-xs text-gray-500">Buka toko Anda ‚Äî buat, preview, dan checkout</p>
  </div>
  <div class="flex items-center gap-3">
    <button id="openCartBtn" class="px-3 py-2 rounded-xl bg-green-500 text-white">Keranjang (<span id="cartCount">0</span>)</button>
    <button id="showQRISBtn" class="px-3 py-2 rounded-xl bg-indigo-500 text-white">Lihat QRIS</button>
  </div>
</header>
<footer id="donateFooter">
  <span>Gratis untuk semua</span>
  <a href="https://saweria.co/valitio" target="_blank" rel="noopener noreferrer">
    üíù Dukung via Saweria
  </a>
</footer>

<style>
  #donateFooter {
    position: fixed;
    bottom: 0; left: 0;
    width: 100%;
    background: var(--card);
    border-top: 1px solid var(--border);
    color: var(--text);
    font-size: 0.9rem;
    text-align: center;
    padding: 10px;
    display: flex;
    justify-content: center;
    gap: 10px;
    z-index: 999;
  }
  #donateFooter a {
    color: #f97316;
    font-weight: 600;
    text-decoration: none;
  }
  #donateFooter a:hover {
    text-decoration: underline;
  }
</style>

<main class="max-w-3xl mx-auto grid md:grid-cols-2 gap-4">
  <!-- Katalog / Products -->
  <section class="bg-white rounded-2xl shadow p-4">
    <div id="productsArea"></div>
  </section>

  <!-- Admin Panel (hidden by default) -->
  <aside id="adminPanel" class="bg-white rounded-2xl shadow p-4 hidden">
    <h3 class="font-bold mb-2">Panel Admin</h3>
    <div class="space-y-3">
      <div>
        <label class="text-sm text-gray-600">Nama Toko</label>
        <input id="namaToko" class="w-full p-2 border rounded-xl" />
      </div>
      <div>
        <label class="text-sm text-gray-600">Nomor WhatsApp</label>
        <input id="waNumber" class="w-full p-2 border rounded-xl" placeholder="6281234..." />
      </div>
      <div>
        <label class="text-sm text-gray-600">Logo</label>
        <input id="logoInput" type="file" accept="image/*" class="w-full p-2" />
      </div>

      <div>
        <label class="text-sm text-gray-600">Tambah Kategori</label>
        <div class="flex gap-2">
          <input id="kategoriBaru" class="flex-1 p-2 border rounded-xl" placeholder="Contoh: Minuman" />
          <button id="btnTambahKategori" class="px-3 rounded-xl btn-main text-gray-900">+</button>
        </div>
        <select id="kategoriProduk" class="w-full mt-2 p-2 border rounded-xl"></select>
      </div>

      <div>
        <label class="text-sm text-gray-600">Tambah / Edit Produk</label>
        <input id="namaProduk" class="w-full p-2 border rounded-xl mt-1" placeholder="Nama produk (wajib)" />
        <input id="hargaProduk" class="w-full p-2 border rounded-xl mt-1" placeholder="Harga (kosong => 0)" inputmode="numeric" />
        <textarea id="deskripsiProduk" rows="2" class="w-full p-2 border rounded-xl mt-1" placeholder="Deskripsi (opsional)"></textarea>
        <input id="fotoProduk" type="file" accept="image/*" class="w-full p-2 mt-1" />
        <button id="btnProduk" class="w-full mt-2 py-2 rounded-xl btn-main font-semibold text-gray-900">+ Tambah Produk</button>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="text-sm text-gray-600">Tampilan</label>
          <select id="viewMode" class="w-full p-2 border rounded-xl">
            <option value="grid">Grid</option>
            <option value="list">List</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-600">Tema</label>
          <select id="themeColor" class="w-full p-2 border rounded-xl">
            <option value="blue">Biru</option>
            <option value="green">Hijau</option>
            <option value="purple">Ungu</option>
            <option value="cream">Krem</option>
          </select>
        </div>
      </div>

      <div>
        <label class="text-sm text-gray-600">Upload QRIS (gambar)</label>
        <input id="qrisInput" type="file" accept="image/*" class="w-full p-2" />
      </div>

      <div>
        <label class="text-sm text-gray-600">Ubah PIN</label>
        <div class="grid grid-cols-2 gap-2">
          <input id="oldPin" type="password" inputmode="numeric" maxlength="6" placeholder="PIN lama" class="p-2 border rounded-xl" />
          <input id="newPin" type="password" inputmode="numeric" maxlength="6" placeholder="PIN baru" class="p-2 border rounded-xl" />
        </div>
        <button id="btnUbahPin" class="w-full mt-2 py-2 rounded-xl bg-amber-500 text-white">Ubah PIN</button>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <button id="btnBackup" class="py-2 rounded-xl bg-sky-500 text-white">Backup JSON</button>
        <label for="importFile" class="py-2 rounded-xl bg-indigo-500 text-white text-center cursor-pointer">Import JSON</label>
        <input id="importFile" type="file" accept="application/json" class="hidden" />
      </div>

      <div class="flex gap-2">
        <button id="btnReset" class="flex-1 py-2 rounded-xl bg-red-500 text-white">Reset Data</button>
        <button id="btnLogout" class="flex-1 py-2 rounded-xl bg-gray-300">Logout</button>
      </div>
    </div>
  </aside>
</main>

<!-- Preview / Logo and QRIS hidden elements -->
<img id="previewLogo" src="" alt="logo" class="hidden" />
<img id="qrisPreview" src="" alt="qris" class="hidden" />

<!-- PIN Modal -->
<div id="pinModal" class="fixed inset-0 hidden items-center justify-center backdrop z-50">
  <div class="bg-white rounded-2xl p-6 w-[90vw] max-w-sm">
    <h3 id="pinModalTitle" class="font-bold text-lg mb-2">Masuk Admin</h3>
    <p id="pinModalSubtitle" class="text-xs text-gray-500 mb-3">Masukkan PIN untuk mengakses panel admin.</p>
    <input id="pinInput" type="password" inputmode="numeric" maxlength="6" class="w-full p-3 border rounded-xl" placeholder="PIN" />
    <div class="flex gap-2 mt-3">
      <button id="pinOk" class="flex-1 py-2 rounded-xl btn-main text-gray-900">OK</button>
      <button id="pinCancel" class="flex-1 py-2 rounded-xl bg-gray-200">Batal</button>
    </div>
  </div>
</div>

<!-- Cart Modal -->
<div id="cartModal" class="fixed inset-0 hidden items-end md:items-center justify-center backdrop z-40">
  <div class="bg-white w-full md:w-[28rem] rounded-t-2xl md:rounded-2xl p-4 shadow-xl max-h-[90vh] overflow-auto">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-semibold">üõí Keranjang</h3>
      <button id="closeCart" class="text-sm text-gray-500">Tutup</button>
    </div>
    <div id="cartItems" class="space-y-2"></div>
    <div class="border-t mt-3 pt-3 flex items-center justify-between">
      <span class="text-sm text-gray-600">Total</span>
      <span id="cartTotal" class="font-bold">Rp 0</span>
    </div>
    <div class="mt-3 grid grid-cols-2 gap-2">
      <button id="btnCartToWA" class="bg-green-500 text-white py-2 rounded-xl">Order via WA</button>
      <button id="btnShowQRISFromCart" class="bg-indigo-500 text-white py-2 rounded-xl">Lihat QRIS</button>
    </div>
  </div>
</div>

<!-- QRIS Modal (checkout) -->
<div id="qrisModal" class="fixed inset-0 hidden items-center justify-center backdrop z-50">
  <div class="bg-white rounded-2xl p-4 w-[90vw] max-w-sm shadow-xl">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-semibold">QRIS & Total</h3>
      <button id="closeQRIS" class="text-sm text-gray-500">Tutup</button>
    </div>
    <div class="text-center">
      <img id="qrisModalImg" src="" alt="qris" class="mx-auto w-56 h-56 object-contain rounded-lg border" />
      <p class="mt-3 font-semibold">Total: <span id="qrisTotal">Rp 0</span></p>
    </div>
  </div>
</div>

<script>
// ---------- Keys ----------
const LSK = { DATA: 'toko:data', PIN: 'toko:pin', LOGGED: 'toko:logged' };

// ---------- State ----------
let produkList = [];
let kategoriList = [];
let editId = null;
let cart = [];

// ---------- Helpers ----------
function formatRupiah(n){ const x = Number(n||0); return 'Rp ' + x.toLocaleString('id-ID'); }

function saveAll(){
  const data = {
    store: {
      nama: document.getElementById('namaToko').value || '',
      wa: document.getElementById('waNumber').value || '',
      theme: document.getElementById('themeColor').value || 'blue',
      view: document.getElementById('viewMode').value || 'grid'
    },
    produk: produkList,
    kategori: kategoriList,
    assets: {
      logo: document.getElementById('previewLogo').dataset.src || '',
      qris: document.getElementById('qrisPreview').dataset.src || ''
    }
  };
  localStorage.setItem(LSK.DATA, JSON.stringify(data));
}

function loadAll(){
  const raw = localStorage.getItem(LSK.DATA);
  if(!raw) return;
  try{
    const data = JSON.parse(raw);
    document.getElementById('namaToko').value = data.store?.nama || '';
    document.getElementById('waNumber').value = data.store?.wa || '';
    document.getElementById('themeColor').value = data.store?.theme || 'blue';
    document.getElementById('viewMode').value = data.store?.view || 'grid';
    kategoriList = Array.isArray(data.kategori) ? data.kategori : [];
    produkList = Array.isArray(data.produk) ? data.produk : [];
    if(data.assets?.logo) setLogoPreview(data.assets.logo);
    if(data.assets?.qris) setQRISPreview(data.assets.qris);
    renderKategoriOptions();
    applyTheme();
    renderProducts();
  }catch(e){ console.error('Load failed', e); }
}

function setLogoPreview(src){ const logo = document.getElementById('previewLogo'); logo.dataset.src = src; logo.src = src; logo.classList.remove('hidden'); document.getElementById('siteTitle').textContent = document.getElementById('namaToko').value || 'Nama Toko'; }
function setQRISPreview(src){ const q = document.getElementById('qrisPreview'); q.dataset.src = src; q.src = src; }

function applyTheme(){ const theme = document.getElementById('themeColor').value; document.body.classList.remove('theme-blue','theme-green','theme-purple','theme-cream'); document.body.classList.add('theme-'+theme); saveAll(); }

function renderKategoriOptions(){ const sel = document.getElementById('kategoriProduk'); sel.innerHTML = '<option value="">-- Pilih Kategori (opsional) --</option>'; kategoriList.forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); }); }

// ---------- Auth (PIN + Login) ----------
function openPinModal(setupMode=false){
  document.getElementById('pinModal').classList.remove('hidden');
  document.getElementById('pinModalTitle').textContent = setupMode ? 'Buat PIN Baru' : 'Masuk Admin';
  document.getElementById('pinModalSubtitle').textContent = setupMode ? 'Buat PIN 4-6 digit.' : 'Masukkan PIN untuk mengakses panel admin.';
  document.getElementById('pinInput').value='';
  document.getElementById('pinOk').onclick = ()=>{
    const val = document.getElementById('pinInput').value.trim();
    if(setupMode){ if(!/^[0-9]{4,6}$/.test(val)) return alert('PIN harus 4-6 digit angka.'); localStorage.setItem(LSK.PIN,val); document.getElementById('pinModal').classList.add('hidden'); alert('PIN disimpan. Silakan login.'); }
    else{ const cur = localStorage.getItem(LSK.PIN); if(!cur){ document.getElementById('pinModal').classList.add('hidden'); openPinModal(true); return; } if(val===cur){ localStorage.setItem(LSK.LOGGED,'1'); document.getElementById('pinModal').classList.add('hidden'); showAdmin(); } else alert('PIN salah'); }
  };
  document.getElementById('pinCancel').onclick = ()=> document.getElementById('pinModal').classList.add('hidden');
}

function logoutAdmin(){ localStorage.removeItem(LSK.LOGGED); hideAdmin(); alert('Anda telah logout.'); }

function showAdmin(){ document.getElementById('adminPanel').classList.remove('hidden'); }
function hideAdmin(){ document.getElementById('adminPanel').classList.add('hidden'); }

function tryAutoShowAdmin(){ if(localStorage.getItem(LSK.LOGGED)) showAdmin(); else hideAdmin(); }

// ---------- Produk CRUD & UI ----------
function tambahKategori(){ const kat = document.getElementById('kategoriBaru').value.trim(); if(!kat) return; if(!kategoriList.includes(kat)) kategoriList.push(kat); document.getElementById('kategoriBaru').value=''; renderKategoriOptions(); saveAll(); }

function handleAddOrEditProduk(){ const nama = document.getElementById('namaProduk').value.trim(); let harga = document.getElementById('hargaProduk').value.trim(); const desk = document.getElementById('deskripsiProduk').value.trim(); const kat = document.getElementById('kategoriProduk').value;
  if(!nama) return alert('Nama produk wajib diisi.'); if(harga==='') harga='0'; if(isNaN(Number(harga))) return alert('Harga harus angka.');
  const fotoFile = document.getElementById('fotoProduk').files[0];
  const commit = (imgSrc)=>{
    if(editId){ const i = produkList.findIndex(p=>p.id===editId); if(i>-1){ produkList[i].nama=nama; produkList[i].harga=Number(harga); produkList[i].deskripsi=desk; produkList[i].kategori=kat; if(imgSrc!==null) produkList[i].foto=imgSrc; } editId=null; document.getElementById('btnProduk').textContent = '+ Tambah Produk'; }
    else{ produkList.push({ id: Date.now(), nama, harga: Number(harga), deskripsi: desk, kategori: kat, foto: imgSrc }); }
    resetProdukForm(); saveAll(); renderProducts();
  };
  if(fotoFile){ const r=new FileReader(); r.onload=e=>commit(e.target.result); r.readAsDataURL(fotoFile); } else commit(null);
}

function editProduk(id){ const p = produkList.find(x=>x.id===id); if(!p) return; document.getElementById('namaProduk').value = p.nama; document.getElementById('hargaProduk').value = p.harga; document.getElementById('deskripsiProduk').value = p.deskripsi||''; document.getElementById('kategoriProduk').value = p.kategori||''; document.getElementById('fotoProduk').value=''; editId = id; document.getElementById('btnProduk').textContent = '‚úî Simpan Perubahan'; }

function hapusProduk(id){ if(!confirm('Hapus produk ini?')) return; produkList = produkList.filter(p=>p.id!==id); saveAll(); renderProducts(); }

function resetProdukForm(){ document.getElementById('namaProduk').value=''; document.getElementById('hargaProduk').value=''; document.getElementById('deskripsiProduk').value=''; document.getElementById('fotoProduk').value=''; document.getElementById('kategoriProduk').value=''; }

function renderProducts(){ const container = document.getElementById('productsArea'); container.innerHTML=''; document.getElementById('siteTitle').textContent = document.getElementById('namaToko').value || 'Nama Toko';
  const view = document.getElementById('viewMode').value;
  // group by category
  const groups = {};
  produkList.forEach(p=>{ const k = p.kategori || 'Umum'; if(!groups[k]) groups[k]=[]; groups[k].push(p); });
  Object.keys(groups).forEach(kat=>{
    const section = document.createElement('div'); section.className='mb-4';
    const title = document.createElement('h3'); title.className='font-bold text-gray-700 mb-2'; title.textContent = kat; section.appendChild(title);
    const grid = document.createElement('div'); grid.className = (view==='grid') ? 'grid grid-cols-2 gap-3' : 'flex flex-col gap-3';
    groups[kat].forEach(item=>{
      const card = document.createElement('div'); card.className='border rounded-xl p-3 bg-white shadow flex flex-col';
      if(item.foto){ const img = document.createElement('img'); img.src = item.foto; img.className='w-full h-36 object-cover rounded-lg mb-2'; card.appendChild(img); }
      const info = document.createElement('div'); info.innerHTML = `<p class="font-semibold">${item.nama}</p><p class="text-sm text-gray-500">${formatRupiah(item.harga)}</p><p class="text-xs text-gray-400">${item.deskripsi||''}</p>`;
      card.appendChild(info);
      const actions = document.createElement('div'); actions.className='flex gap-2 mt-2';
      const addBtn = document.createElement('button'); addBtn.className='flex-1 py-2 rounded-lg btn-main text-gray-900'; addBtn.textContent='Tambah'; addBtn.onclick = ()=>addToCart(item);
      const waBtn = document.createElement('a'); waBtn.className='flex-1 py-2 rounded-lg bg-green-500 text-white text-center'; waBtn.textContent='Order WA'; waBtn.href = `https://wa.me/${document.getElementById('waNumber').value.trim()}?text=${encodeURIComponent('Halo saya mau pesan '+item.nama)}`; waBtn.target='_blank';
      actions.appendChild(addBtn); actions.appendChild(waBtn);
      // if admin is visible, show edit/hapus small buttons
      if(document.getElementById('adminPanel').classList.contains('hidden')===false){ const editBtn=document.createElement('button'); editBtn.className='px-2 py-1 bg-yellow-500 text-white rounded'; editBtn.textContent='Edit'; editBtn.onclick=()=>editProduk(item.id); const delBtn=document.createElement('button'); delBtn.className='px-2 py-1 bg-red-500 text-white rounded'; delBtn.textContent='Hapus'; delBtn.onclick=()=>hapusProduk(item.id); actions.appendChild(editBtn); actions.appendChild(delBtn); }
      card.appendChild(actions); grid.appendChild(card);
    });
    section.appendChild(grid); container.appendChild(section);
  });
}

// ---------- Cart ----------
function addToCart(item){ const ex = cart.find(c=>c.id===item.id); if(ex) ex.qty++; else cart.push({ id:item.id, nama:item.nama, harga:Number(item.harga), qty:1 }); updateCartBadge(); renderCart(); }
function removeFromCart(id){ cart = cart.filter(c=>c.id!==id); updateCartBadge(); renderCart(); }
function changeQty(id,delta){ const it = cart.find(c=>c.id===id); if(!it) return; it.qty += delta; if(it.qty<=0) removeFromCart(id); updateCartBadge(); renderCart(); }
function cartTotal(){ return cart.reduce((s,c)=> s + c.harga*c.qty, 0); }
function updateCartBadge(){ const n = cart.reduce((s,c)=> s+c.qty, 0); document.getElementById('cartCount').textContent = n; }
function renderCart(){ const wrap = document.getElementById('cartItems'); wrap.innerHTML=''; cart.forEach(c=>{ const row = document.createElement('div'); row.className='flex items-center justify-between border rounded-xl p-2'; const left = document.createElement('div'); left.innerHTML=`<p class="font-semibold text-sm">${c.nama}</p><p class="text-xs text-gray-500">${formatRupiah(c.harga)}</p>`; const qty = document.createElement('div'); qty.className='flex items-center gap-2'; const btnMinus=document.createElement('button'); btnMinus.className='px-2 py-1 bg-gray-200 rounded'; btnMinus.textContent='-'; btnMinus.onclick=()=>changeQty(c.id,-1); const span=document.createElement('span'); span.textContent=c.qty; const btnPlus=document.createElement('button'); btnPlus.className='px-2 py-1 bg-gray-200 rounded'; btnPlus.textContent='+'; btnPlus.onclick=()=>changeQty(c.id,1); const del=document.createElement('button'); del.className='ml-2 px-2 py-1 bg-red-500 text-white rounded'; del.textContent='Hapus'; del.onclick=()=>removeFromCart(c.id); qty.appendChild(btnMinus); qty.appendChild(span); qty.appendChild(btnPlus); qty.appendChild(del); row.appendChild(left); row.appendChild(qty); wrap.appendChild(row); }); document.getElementById('cartTotal').textContent = formatRupiah(cartTotal()); }

function openCart(){ renderCart(); document.getElementById('cartModal').classList.remove('hidden'); }
function closeCart(){ document.getElementById('cartModal').classList.add('hidden'); }

function orderCartViaWA(){ const wa = document.getElementById('waNumber').value.trim(); if(!wa) return alert('Nomor WA belum diisi.'); if(cart.length===0) return alert('Keranjang kosong.'); const lines = cart.map(c=> `- ${c.nama} x${c.qty} = ${formatRupiah(c.harga*c.qty)}`).join('%0A'); const total = formatRupiah(cartTotal()); const text = `Halo, saya mau pesan:%0A${lines}%0A%0ATotal: ${total}`; const url = `https://wa.me/${wa}?text=${text}`; window.open(url,'_blank'); }

function openQRISFromCart(){ const src = document.getElementById('qrisPreview').dataset.src; if(!src) return alert('QRIS belum diupload.'); document.getElementById('qrisModalImg').src = src; document.getElementById('qrisTotal').textContent = formatRupiah(cartTotal()); document.getElementById('qrisModal').classList.remove('hidden'); }

// ---------- QRIS + Logo Upload ----------
function handleLogoUpload(e){ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ setLogoPreview(ev.target.result); saveAll(); renderProducts(); }; r.readAsDataURL(f); }
function handleQRISUpload(e){ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ setQRISPreview(ev.target.result); saveAll(); }; r.readAsDataURL(f); }

// ---------- Backup / Import / Reset ----------
function doBackup(){ saveAll(); const raw = localStorage.getItem(LSK.DATA) || '{}'; const blob = new Blob([raw],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='toko-backup.json'; a.click(); URL.revokeObjectURL(url); }
function doImport(file){ const r=new FileReader(); r.onload=e=>{ try{ const data = JSON.parse(e.target.result); localStorage.setItem(LSK.DATA, JSON.stringify(data)); loadAll(); alert('Import berhasil.'); }catch(err){ alert('File tidak valid.'); } }; r.readAsText(file); }
function doReset(){ if(!confirm('Reset semua data? Tindakan ini tidak bisa dibatalkan.')) return; localStorage.removeItem(LSK.DATA); localStorage.removeItem(LSK.PIN); localStorage.removeItem(LSK.LOGGED); produkList=[]; kategoriList=[]; cart=[]; document.getElementById('previewLogo').dataset.src=''; document.getElementById('qrisPreview').dataset.src=''; document.getElementById('previewLogo').src=''; document.getElementById('qrisPreview').src=''; renderKategoriOptions(); renderProducts(); applyTheme(); updateCartBadge(); alert('Data telah direset.'); }

// ---------- PIN change ----------
function changePIN(){ const oldp = document.getElementById('oldPin').value.trim(); const newp = document.getElementById('newPin').value.trim(); const cur = localStorage.getItem(LSK.PIN) || ''; if(!oldp || !newp) return alert('Isi PIN lama dan PIN baru.'); if(oldp !== cur) return alert('PIN lama salah.'); if(!/^[0-9]{4,6}$/.test(newp)) return alert('PIN baru 4-6 digit angka.'); localStorage.setItem(LSK.PIN,newp); document.getElementById('oldPin').value=''; document.getElementById('newPin').value=''; alert('PIN berhasil diubah.'); }

// ---------- Events ----------
window.addEventListener('DOMContentLoaded', ()=>{
  // load
  loadAll();
  tryAutoShowAdmin();

  // Gear button opens PIN modal (if no PIN set -> prompt create)
  document.getElementById('gearBtn').addEventListener('click', ()=>{ const cur = localStorage.getItem(LSK.PIN); openPinModal(!cur); });

  // admin actions
  document.getElementById('btnTambahKategori').addEventListener('click', tambahKategori);
  document.getElementById('btnProduk').addEventListener('click', handleAddOrEditProduk);
  document.getElementById('logoInput').addEventListener('change', handleLogoUpload);
  document.getElementById('qrisInput').addEventListener('change', handleQRISUpload);
  document.getElementById('btnUbahPin').addEventListener('click', changePIN);
  document.getElementById('btnBackup').addEventListener('click', doBackup);
  document.getElementById('importFile').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f) doImport(f); e.target.value=''; });
  document.getElementById('btnReset').addEventListener('click', doReset);
  document.getElementById('btnLogout').addEventListener('click', ()=>{ logoutAdmin(); });

  // preview inputs save
  document.getElementById('namaToko').addEventListener('input', ()=>{ document.getElementById('siteTitle').textContent = document.getElementById('namaToko').value || 'Nama Toko'; saveAll(); });
  document.getElementById('waNumber').addEventListener('input', ()=> saveAll());
  document.getElementById('themeColor').addEventListener('change', applyTheme);
  document.getElementById('viewMode').addEventListener('change', ()=>{ renderProducts(); saveAll(); });

  // cart & qris
  document.getElementById('openCartBtn').addEventListener('click', ()=>{ openCart(); });
  document.getElementById('closeCart').addEventListener('click', closeCart);
  document.getElementById('btnCartToWA').addEventListener('click', orderCartViaWA);
  document.getElementById('btnShowQRISFromCart').addEventListener('click', openQRISFromCart);
  document.getElementById('showQRISBtn').addEventListener('click', ()=>{ const src = document.getElementById('qrisPreview').dataset.src; if(!src) return alert('QRIS belum diupload.'); document.getElementById('qrisModalImg').src = src; document.getElementById('qrisTotal').textContent = formatRupiah(cartTotal()); document.getElementById('qrisModal').classList.remove('hidden'); });
  document.getElementById('closeQRIS').addEventListener('click', ()=> document.getElementById('qrisModal').classList.add('hidden'));

  // pin modal cancel
  document.getElementById('pinCancel').addEventListener('click', ()=> document.getElementById('pinModal').classList.add('hidden'));

  // pin modal overlay OK handled inside openPinModal
});
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("Service Worker registered"))
        .catch(err => console.error("SW registration failed:", err));
    }
  </script>
</body>
</html>
